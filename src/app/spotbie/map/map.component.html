<app-loading-screen *ngIf="(loading$ | async)"></app-loading-screen>

<div class='spotbie-overlay-window' #parentWindow id="spotbieMainSpotBieScroll">

  <div [ngClass]="getMapWrapperClass()">
    <div #singleAdAppAnchor></div>
    <div #scrollMapAppAnchor></div>

    <div class="sb-dashboardWrapper sb-v-wrapper"
         style="display: grid;
                align-content: center;
                min-height: 70vh;"
         *ngIf="displayLocationEnablingInstructions">

      <i class="fas fa-map-marker-alt"></i>

      <h2 class="spotbie-text-gradient text-uppercase mt-4" style="display: inline-block;">BONKERS!</h2>

      <div class='spotbie-text-gradient mt-2'>LOCATION DISABLED</div>

      <p class="sb-locationList spotbie-text-gradient text-center mt-3">
        <span>Open Device Settings</span>
        <span>Navigate to Apps > Permissions</span>
        <span>Enable Location Usage for SpotBie</span>
      </p>

      <div class="spotbie-button" (click)="spawnCategories(1)">
        <span class="spotbie-text-gradient text-uppercase mt-5 cursor-pointer">TRY LOCATION</span>
      </div>
    </div>

    <google-map [ngClass]="getMapClass()"
                *ngIf="map"
                [width]="'{{ width }}'"
                [center]="center"
                [zoom]="zoom">
    </google-map>

<!--    <agm-map  [ngClass]="getMapClass()"
              [streetViewControl]="false"
              *ngIf="map"
              #spotbie_map
              [latitude]="lat"
              [longitude]="lng"
              [styles]="mapStyles"
              [zoom]="zoom"
              [gestureHandling]="'cooperative'"
              [fitBounds]="fitBounds">

&lt;!&ndash;      <agm-overlay [latitude]="lat" [longitude]="lng" *ngIf="locationFound">
        <div class='spotbie-marker-bg'
             *ngIf="iconUrl"
             [ngStyle]="{'background' : 'url(' + iconUrl + ')',
                            'border' : '2px solid' }">
        </div>
      </agm-overlay>&ndash;&gt;

&lt;!&ndash;      <agm-marker [latitude]="lat"
                  [longitude]="lng"
                  *ngIf="locationFound"
                  [opacity]="0"
                  [agmFitBounds]="true">

        <agm-info-window #spotbie_user_marker_info_window [isOpen]="true">
          <div class='agm_infowindow_color'>{{ spotbieUsername }}</div>
        </agm-info-window>
      </agm-marker>&ndash;&gt;

      <div *ngIf="displaySurroundingObjectList">
        <agm-overlay *ngFor="let mapObject of surroundingObjectList"
                     [latitude]="mapObject.loc_x"
                     [longitude]="mapObject.loc_y">
          <div class='spotbie-marker-bg'
               (click)="pullMarker(mapObject)"
               title="{{ mapObject.username }}"
               [ngStyle]="{ 'background' : 'url(' + mapObject.map_icon + ')' }">
          </div>
        </agm-overlay>
      </div>

      <div *ngIf="showSearchBox && searchResults.length > 0">
        <div *ngFor="let mapObject of searchResults">
          <div *ngIf="mapObject.business_id == undefined">
            <agm-overlay
              [latitude]="mapObject.coordinates.latitude"
              [longitude]="mapObject.coordinates.longitude">
              <div class='spotbie-marker-bg'
                   (click)="pullSearchMarker(mapObject)"
                   [ngStyle]="{ 'background' : 'url(' + mapObject.icon + ')' }">
              </div>
            </agm-overlay>

            <agm-marker [latitude]="mapObject.coordinates.latitude"
                        [longitude]="mapObject.coordinates.longitude"
                        [agmFitBounds]="checkSearchResultsFitBounds()"
                        [visible]="false">
            </agm-marker>
          </div>
        </div>

        <agm-overlay *ngFor="let communityMember of communityMemberList"
                     [latitude]="communityMember.loc_x"
                     [longitude]="communityMember.loc_y">

          <div class='spotbie-marker-bg sb-communityMember pulse'
               (click)="pullSearchMarker(communityMember)"
               [ngStyle]="{ 'background' : 'url(' + communityMember.photo + ')' }">
            <img src="assets/images/home_imgs/spotbie-green-icon.svg" />
          </div>

        </agm-overlay>

        <agm-marker *ngFor="let communityMember of communityMemberList"
                    [latitude]="communityMember.loc_x"
                    [longitude]="communityMember.loc_y"
                    [agmFitBounds]="checkCommunityMemberFitBounds()"
                    [visible]="false"></agm-marker>

      </div>
    </agm-map>-->

    <div class='spotbie-categoryPull' *ngIf="!isDesktop && map">
      <div class='sb-optionGet' (click)="spawnCategories(1)">
        <img src="assets/images/home_imgs/find-places-to-eat.svg" />
      </div>

      <div class='sb-optionGet' (click)="spawnCategories(3)">
        <img src="assets/images/home_imgs/find-events.svg" />
      </div>

      <div class='sb-optionGet' (click)="spawnCategories(1)">
        <img src="assets/images/home_imgs/find-places-for-shopping.svg" />
      </div>
    </div>

    <app-bottom-ad-banner
      class='mt-4'
      *ngIf="map && locationFound && searchResults.length < 1 && isMobile"
      [eventsClassification]="eventsClassification"
      [accountType]="searchCategory"
      [categories]="bottomBannerCategories"
      [lat]="lat"
      [lng]="lng">
    </app-bottom-ad-banner>

    <div class='spotbie-search-results' *ngIf="showSearchBox && searchResults.length > 0">
      <div #scrollMapAppAnchor></div>

      <app-header-ad-banner #singleAdApp class='spotbie-ad'
                            [eventsClassification]="eventsClassification"
                            [accountType]="searchCategory"
                            [categories]="numberCategories"
                            [lat]="lat"
                            [lng]="lng"></app-header-ad-banner>

      <div class='spotbie-search-results-title text-uppercase' *ngIf="typeOfInfoObject === 'yelp_business'">
        Distance {{ maxDistance }} mi.
        <mat-slider min="1" max="25" step="1"
                    (change)="updateDistance($event)"></mat-slider>
      </div>

      <div class='spotbie-search-results-title text-uppercase' *ngIf="typeOfInfoObject === 'ticketmaster_events'">
        Distance
        <mat-slider min="1" max="50" step="1" (change)="updateDistance($event)"></mat-slider>
        {{ maxDistance }} mi.
      </div>

      <div class='spotbie-search-results-title'>
        <table class='spotbie-controls-search-results' *ngIf="searchCategorySorter === 1">
          <tr>
            <td (click)="sortBy(0)" title="Sort By Distance">
              <img src='assets/images/map/distance.svg' />
            </td>

            <td (click)="sortBy(1)" title="Sort By Rating">
              <img src='assets/images/map/ratings.svg' />
            </td>

            <td (click)="sortBy(2)" title="Sort By Reviews">
              <img src='assets/images/map/reviews.svg' />
            </td>

            <td (click)="sortBy(3)" title="Sory By Pricing">
              <img src='assets/images/map/pricing.svg' />
            </td>

            <td (click)="sortBy(4)" title="Offers Delivery">
              <img class="sb-deliverySortImg"  src='assets/images/map/delivery.svg' />
            </td>

            <td (click)="sortBy(5)" title="Offers Pick-Up">
              <img class="sb-pickUpSortImg"  src='assets/images/map/pick-up.svg' />
            </td>

            <td (click)="sortBy(6)" title="Offers Reservations">
              <img class="sb-reservationsSortImg" src='assets/images/map/reservations.svg' />
            </td>
          </tr>
        </table>

        <div class="mt-4 mb-4 text-uppercase">
          Sorted by {{ sortByTxt }}
          <span *ngIf="sortAc !== 4 && sortAc !== 5 && sortAc !== 6 && sortAc !== 7 && sortAc !== 8">
            <i [ngClass]="sortingOrderClass(sortingOrder)"></i>
          </span>
        </div>

        <table class='spotbie-controls-search-results'
               (click)="showOpen()"
               title="Opened or Closed"
               [ngStyle]="{ 'border-right' : 'unset' }"
               *ngIf="searchCategorySorter === 1">

          <td *ngIf="!isMobile">
            <span class='fa fa-circle spotbie-is-open'></span>
          </td>

          <td *ngIf="!(showOpened$ | async) && !isMobile">
            <span class='fa fa-circle spotbie-is-closed'></span>
          </td>

          <td *ngIf="(showOpened$ | async) ">
            OPEN
          </td>

          <td *ngIf="!(showOpened$ | async) ">
            OPEN/CLOSED
          </td>
        </table>

        <table class='spotbie-controls-search-results' *ngIf="searchCategorySorter === 2">
          <tr>
            <td (click)="sortBy(0)" title="Sort By Distance">
              <img src='assets/images/map/distance.svg' />
            </td>

            <td (click)="sortBy(1)" title="Sort By Rating">
              <img src='assets/images/map/ratings.svg' />
            </td>

            <td (click)="sortBy(2)" title="Sort By Reviews">
              <img src='assets/images/map/reviews.svg' />
            </td>

            <td (click)="sortBy(3)" [ngStyle]="{ 'border-right' : 'unset' }"  title="Sory By Pricing">
              <img src='assets/images/map/pricing.svg' />
            </td>
          </tr>
        </table>

        <table  class='spotbie-controls-search-results'
                (click)="showOpen()"
                title="Opened or Closed"
                [ngStyle]="{ 'border-right' : 'unset' }"
                *ngIf="searchCategorySorter === 2">

          <td *ngIf="!isMobile">
            <span class='fa fa-circle spotbie-is-open'></span>
          </td>

          <td *ngIf="!(showOpened$ | async) && !isMobile">
            <span class='fa fa-circle spotbie-is-closed'></span>
          </td>

          <td *ngIf="(showOpened$ | async) ">
            OPEN
          </td>

          <td *ngIf="!(showOpened$ | async) ">
            OPEN/CLOSED
          </td>
        </table>

        <table class='spotbie-controls-search-results text-uppercase' *ngIf="searchCategorySorter === 3">
          <tr>
            <td (click)="hideSearchResults()" title="Hide Results"><img src='assets/images/map/hide.svg' /></td>
            <td (click)="sortBy(0)" title="Sort By Distance"><img src='assets/images/map/distance.svg' /></td>
            <td (click)="sortBy(3)" title="Sort By Pricing"><img src='assets/images/map/pricing.svg' /></td>
            <td (click)="sortBy(7)" title="Events Today">Today</td>
            <td (click)="sortBy(8)" title="Events This Weekend" [ngStyle]="{ 'border-right' : 'unset' }">This Weekend</td>
          </tr>
        </table>
      </div>

      <div class='spotbie-search-results-title spotbie-sorting text-uppercase'>
        <ng-template *ngIf="searchCategorySorter !== 3">
          <span class='fa fa-circle spotbie-is-open' [ngStyle]="{ 'margin-left' : '5px' }"></span>
          <span class='fa fa-circle spotbie-is-closed' *ngIf="!(showOpened$ | async)" [ngStyle]="{ 'margin-left' : '5px' }"></span>
        </ng-template>
      </div>

      <div class='spotbie-search-result-wrapper' *ngIf="showSearchResults">
        <div class='spotbie-search-results-title text-uppercase' style="margin-top:0px;" *ngIf="communityMemberList.length > 0">
          <img src="assets/images/home_imgs/spotbie-green-icon.svg" class="sb-miniLogoIconM">
          SPOTBIE COMMUNITY MEMBERS
        </div>

        <!-- First let's display the spotbie community member list for -->
        <div class='spotbie-search-result spotbie-communityMember-search-result'
             *ngFor='let communityMember of communityMemberList'
             (click)="pullSearchMarker(communityMember)">
          <table class='spotbie-search-result-table'>
            <tr>
              <td>
                <img class='sb-miniLogoIcon' src="assets/images/home_imgs/spotbie-green-icon.svg" />
                <div class='spotbie-search-result-image' [ngStyle]="{ 'background' : 'url(' + communityMember.photo + ')' }" ></div>
              </td>
              <td>
                <h6 class='spotbie-search-result-title sb-text-light-green-gradient' style='font-size: .8rem;'>
                  {{ communityMember.name | truncateText:[20, '...'] }}
                </h6>

                <p style='font-size: .5rem; text-overflow: ellipsis; max-height: 30px' class='spotbie-text-gradient mt-3'>
                  {{ communityMember.description | truncateText:[20, '...'] }}
                </p>

                <p style='font-size: .5rem;' class="spotbie-text-gradient mt-3">
                  {{ communityMember.cleanCategories | truncateText:[20, '...']}}
                </p>

                <div class='sb-community-member-brand'>
                  <span class='sb-text-light-green-gradient text-uppercase'>{{ communityMember.rewardRate | currency: 'USD' }} per DOLLAR</span>
                </div>
              </td>
            </tr>
          </table>
        </div>

        <div class='spotbie-no-results mt-4 mb-4 text-uppercase' *ngIf="searchResults.length === 0">No results available.</div>

        <div class='spotbie-search-result' *ngFor='let search_result of searchResults' (click)="pullSearchMarker(search_result)">
          <table class='spotbie-search-result-table'>
            <tr>
              <td *ngIf="search_result.image_url !== '0'">
                <div class='spotbie-search-result-image'[ngStyle]="{ 'background' : 'url(' + search_result.image_url + ')' }" ></div>
              </td>

              <td *ngIf="typeOfInfoObject === 'yelp_business'">
                <div class='spotbie-search-result-title' >
                  {{ search_result.name }}
                </div>

                <table class='spotbie-yelp-rating-table'>
                  <tr>
                    <td>
                      <div class='spotbie-search-result-rating-img' [ngStyle]="{ 'background' : 'url(' + search_result.rating_image + ')' }"></div>
                    </td>

                    <td>
                      <div class='spotbie-search-result-yelp-logo' [ngStyle]="{ 'background' : 'url(assets/images/yelp/yelp_logo.png)' }"></div>
                    </td>
                  </tr>
                </table>

                <div class='spotbie-review-count'>
                  Based on {{ search_result.review_count }} Reviews
                </div>

                <div class='spotbie-distance'>
                  {{ search_result.distance }} miles from you.
                </div>

                <div class='spotbie-search-result-phone' *ngIf="search_result.phone !== ''">
                  {{ search_result.display_phone }}
                </div>
              </td>
              <td *ngIf="typeOfInfoObject === 'ticketmaster_events'">
                <div class='spotbie-venue-name' *ngIf="search_result._embedded.venues[0]">
                  {{ search_result._embedded.venues[0].name }}
                </div>

                <div class='spotbie-distance'>
                  {{ search_result.distance }} miles from you.
                </div>

                <div class='spotbie-time-event' *ngIf="search_result.dates.start.localDate">
                  {{ search_result.dates.start.spotbieDate }}
                </div>

                <div class='spotbie-time-event' *ngIf="search_result.dates.start.spotbieHour">
                  {{ search_result.dates.start.spotbieHour }}
                </div>

                <div class='spotbie-price-ranges' *ngIf="search_result.priceRanges !== undefined">
                  Price Ranges ${{ search_result.priceRanges[0].min }} to ${{ search_result.priceRanges[0].max }}
                </div>

                <div class='spotbie-event-code' *ngIf="search_result.dates.status.code">
                  Status: {{ search_result.dates.status.code }}
                </div>
              </td>
            </tr>
          </table>
          <div class='spotbie-search-result-transactions' *ngIf="search_result.transactions_on === '1'">{{ search_result.friendly_transactions }}</div>
        </div>

        <!--Page Number Wrapper -->
        <div class='mt-5 pb-5'>
          <span class='sb-page-button text-uppercase cursor-pointer' (click)="goToPage(1)" *ngIf="allPages > 1">
            <i class="fa fa-angle-double-left"></i>
          </span>

          <span class='sb-page-button text-uppercase cursor-pointer' (click)="loadMoreResults(0)" *ngIf="allPages > 1">
            <i class="fa fa-angle-left"></i>
          </span>

          <span class="spotbie-result-page"
                (click)="goToPage((aroundMeSearchPage - 2))"
                [ngStyle]="displayPage((aroundMeSearchPage - 2))">{{ aroundMeSearchPage - 2 }}</span>

          <span class="spotbie-result-page"
                (click)="goToPage((aroundMeSearchPage - 1))"
                [ngStyle]="displayPage((aroundMeSearchPage - 1))">{{ aroundMeSearchPage - 1 }}</span>

          <span class="spotbie-result-page active">{{ aroundMeSearchPage }}</span>

          <span class="spotbie-result-page"
                (click)="goToPage((aroundMeSearchPage + 1))"
                [ngStyle]="displayPageNext((aroundMeSearchPage + 1))">{{ aroundMeSearchPage + 1 }}</span>

          <span class="spotbie-result-page"
                (click)="goToPage((aroundMeSearchPage + 2))"
                [ngStyle]="displayPageNext((aroundMeSearchPage + 2))">{{ aroundMeSearchPage + 2 }}</span>

          <span class='sb-page-button text-uppercase cursor-pointer' (click)="loadMoreResults(1)" *ngIf="allPages > 1">
            <i class="fa fa-angle-right"></i>
          </span>

          <span class='sb-page-button text-uppercase cursor-pointer' (click)="goToPage(allPages - 1)" *ngIf="allPages > 1">
            <i class="fa fa-angle-double-right"></i>
          </span>

          <div></div>

          <span class='spotbie-search-page-number'>{{ aroundMeSearchPage }}/{{ allPages - 1 }}</span>
        </div>

        <app-bottom-ad-banner class='mt-4'
                              #bottomAdBanner
                              [eventsClassification]="eventsClassification"
                              [accountType]="searchCategory"
                              [categories]="numberCategories"
                              [lat]="lat"
                              [lng]="lng"></app-bottom-ad-banner>
      </div>
    </div>

    <div class='spotbie-search-results no-results' *ngIf="showNoResultsBox">
      <div class='spotbie-no-results' style="text-align: center;" *ngIf="sortEventDate === 'none'">No results available for "{{ searchKeyword }}" within {{ maxDistance }} miles.</div>
      <div class='spotbie-no-results' style="text-align: center;" *ngIf="sortEventDate === 'today'">No results today available for "{{ searchKeyword }}" within {{ maxDistance }} miles.</div>
      <div class='spotbie-no-results' style="text-align: center;" *ngIf="sortEventDate === 'weekend'">No results this weekend available for "{{ searchKeyword }}" within {{ maxDistance }} miles.</div>

      <div class='spotbie-search-results-title text-uppercase'>
        Distance  <mat-slider min="0" max="{{ maxDistanceCap }}" step="1" (change)="updateDistance($event)"></mat-slider>
        {{ maxDistance }} mi.
      </div>
    </div>

    <div class="sb-footer pt-5 pb-5" *ngIf="showSearchResults || (showSearchResults && isLoggedIn !== '1' )">
      <p (click)="openTerms()">Terms & Privacy Policy</p>
      <img class="mt-3 mb-3" src="assets/images/logo_spotbie_green.svg" />
      <p (click)="openTerms()">SpotBie, LLC.&copy; Copyright 2022</p>
    </div>

    <div class="map-prompt-mobile pe-none" *ngIf="showMobilePrompt2">
      <div class="spotbie-text-gradient text-uppercase title" id="doubleTapThis"></div>
    </div>

    <ng-container *ngIf="isLoggedIn === '1' && !showSearchResults && !map">
      <div class='map-prompt-mobile align-items-center justify-content-center' #featureWrapper>
        <div class='map-prompt-v-align mt-2'>
          <app-user-dashboard (spawnCategoriesEvt)="spawnCategories($event)" #homeDashboard
          ></app-user-dashboard>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Show categories for shopping & food -->
  <div #categoryMenuSlide>
    <div class='spotbie-categories animated slideInRight' *ngIf="(catsUp$ | async) && searchCategory !== 3">
      <div *ngFor="let category of categories; let i = index" [ngClass]="getSingleCatClass(i)" (click)="apiSearch(category)">
        {{ category }}
      </div>
    </div>

    <!-- Show categories for events -->
    <div class='spotbie-categories animated slideInRight' *ngIf="(catsUp$ | async) && searchCategory === 3">
      <div [ngClass]="getSingleCatClass(i)" *ngFor="let category of categories; let i = index" (click)="showEventSub(category)">
        {{ category.name }}

        <!--<div class='spotbie-sub-cat-wrapper' *ngIf="category.show_sub && category.type !== undefined">
          <div class='spotbie-sub-cat' *ngFor="let sub_cat_type of category.type._embedded.subtypes" (click)="apiSearch(sub_cat_type.name)" [SpotBieStopClickPropagation]>
            {{ sub_cat_type.name }}
          </div>
        </div>-->

        <div class='spotbie-sub-cat-wrapper' *ngIf="category.show_sub && category.segment">
          <!--<div class='spotbie-sub-cat' *ngFor="let sub_cat_type of category.segment._embedded.genres" (click)="apiSearch(sub_cat_type.name, true)" [SpotBieStopClickPropagation]>-->
          <div class='spotbie-sub-cat' *ngFor="let sub_cat_type of category.segment._embedded.genres" (click)="apiSearch(sub_cat_type.name, true)">
            {{ sub_cat_type.name }}
            <!--<div *ngIf="sub_cat_type.show_sub_sub">
              <div class='spotbie-subgenre' *ngFor="let subgenre of sub_cat_type._embedded.subgenres" (click)="apiSearch(subgenre.name)" [SpotBieStopClickPropagation]>
                {{ subgenre.name }}
              </div>
            </div> -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class='spotbie-category-search-yelp animated slideInUp' *ngIf="catsUp$ | async">
    <div class='spotbie-categoryPull' *ngIf="!isMobile">
      <div class='sb-optionGet' (click)="spawnCategories(1)">
        <img src="assets/images/home_imgs/find-places-to-eat.svg" />
      </div>

      <div class='sb-optionGet' (click)="spawnCategories(3)">
        <img src="assets/images/home_imgs/find-events.svg" />
      </div>

      <div class='sb-optionGet' (click)="spawnCategories(1)">
        <img src="assets/images/home_imgs/find-places-for-shopping.svg" />
      </div>
    </div>

    <input type='text'
           class='spotbie-searchbar sb-input'
           placeholder="{{ searchCategoriesPlaceHolder }}"
           (keyup)="searchSpotBie($event)" />

    <div class='spotbie-close-categories'
         (click)="closeCategories()">
      close
    </div>
  </div>

  <app-info-object [info_object]="(infoObject$ | async)"
                   [eventsClassification]="eventsClassification"
                   [categories]="numberCategories"
                   [lat]="lat"
                   [lng]="lng"
                   (closeWindow)="infoObject$.next(null)"
                   *ngIf="(infoObject$ | async)">
  </app-info-object>

  <app-user-info-object [currentMarker]="currentMarker"
                        *ngIf="sliderRight"
                        (close)="sliderRight = false"></app-user-info-object>
  <!--<app-my-favorites *ngIf="myFavoritesWindow.open" (closeWindow)="closeFavorites()"></app-my-favorites>-->
  <app-scroll-to-top></app-scroll-to-top>
</div>
